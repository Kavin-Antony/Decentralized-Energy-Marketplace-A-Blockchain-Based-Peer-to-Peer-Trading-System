<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Trade DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <!-- <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
    input, button { margin: 10px; padding: 8px; font-size: 14px; }
    h2 { color: #333; }
    .section { margin-top: 20px; }
    .section h3 { color: #333; }
    .trade-list { list-style-type: none; padding: 0; }
    .trade-list li { margin: 10px 0; background-color: #fff; padding: 15px; border-radius: 5px; border: 1px solid #ddd; }
  </style> -->
</head>
<body>
  <h2>ðŸ”— Energy Trade DApp</h2>
  <!-- <p>Connected Account: <span id="account"></span></p> -->

  <!-- Create Trade Section -->
  <div class="section">
    <h3>âž• Create Trade</h3>
    <input id="energyAmount" placeholder="Energy Amount (in kWh)" />
    <input id="price" placeholder="Price in Ether" />
    <button onclick="createTrade()">Create</button>
  </div>

  <!-- Accept Trade Section -->
  <div class="section">
    <h3>ðŸ›’ Accept Trade</h3>
    <input id="acceptId" placeholder="Trade ID" />
    <button onclick="acceptTrade()">Accept</button>
  </div>

  <!-- Complete Trade Section -->
  <div class="section">
    <h3>âœ… Complete Trade</h3>
    <input id="completeId" placeholder="Trade ID" />
    <button onclick="completeTrade()">Complete</button>
  </div>

  <!-- All Trades Section -->
<div class="section">
  <h3>ðŸ“‹ All Trades</h3>
  <button onclick="loadTrades()">ðŸ”„ Check All Trades</button>
  <ul id="tradeList" class="trade-list"></ul>
</div>

  <script>
    let account;
    let energyTrade;
    const contractAddress = "0x99296c81E34A4d681fB616394A05A5b119334bBb";
    console.log("Contract Address: ", contractAddress);
    let contractABI;

    // Connect to Web3
    window.addEventListener('load', async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById("account").textContent = account;

        // Fetch ABI from local JSON file (served via a Node.js or local web server)
        const res = await fetch("http://localhost:3000/EnergyTrade.json"); // Ensure this path is correct
        const artifact = await res.json();
        contractABI = artifact.abi;

        energyTrade = new web3.eth.Contract(contractABI, contractAddress);

        loadTrades();
      } else {
        alert("Please install MetaMask!");
      }
    });

    // Create a Trade
    async function createTrade() {
      const energy = document.getElementById("energyAmount").value;
      const price = document.getElementById("price").value;
      await energyTrade.methods.createTrade(energy, Web3.utils.toWei(price, 'ether'))
        .send({ from: account });
      loadTrades();
    }

    // Accept a Trade
    async function acceptTrade() {
      const id = document.getElementById("acceptId").value;
      const trade = await energyTrade.methods.getAllTrades().call();
      const tradeDetails = trade[id];
      await energyTrade.methods.acceptTrade(id).send({
        from: account,
        value: web3.utils.toBN(tradeDetails.price)
      });
      loadTrades();
    }

    // Complete a Trade
    async function completeTrade() {
      const id = document.getElementById("completeId").value;
      await energyTrade.methods.completeTrade(id).send({ from: account });
      loadTrades();
    }

    // Load all trades
    async function loadTrades() {
      const trades = await energyTrade.methods.getAllTrades().call();
      const list = document.getElementById("tradeList");
      list.innerHTML = '';
      trades.forEach((t, i) => {
        const item = document.createElement("li");
        item.innerHTML = `
          ID ${i}: ${t.energyAmount} units @ ${Web3.utils.fromWei(t.price)} ETH<br/>
          Seller: ${t.seller}<br/>
          Buyer: ${t.buyer}<br/>
          Accepted: ${t.isAccepted}, Completed: ${t.isCompleted}
          <hr/>
        `;
        list.appendChild(item);
      });
    }
  </script>
</body>
</html>